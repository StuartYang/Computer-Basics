# I/O系统

[TOC]



## IO的基本概念

**IO系统 = IO软件+IO硬件**

- IO软件：括驱动程序、用户程序、管理程序、升级补丁等。通常采用IO指令和通道指令实现CPU与IO设备的信息交换。
- IO硬件：包括外部设备、IO设备控制器（接口）、IO总线等。通过设备控制器来控制IO设
  备的具体动作；通过IO接口与主机（总线）相连。

> 实际上设备控制器就是IO接口，只不过在不同学科中的叫法不同:
>
> - 在操作系统中称之为设备控制器，因为他更注重软件，控制，所以是一种抽象;
>
> - 在计算机组成原理中更注重硬件和实现方式，所以称之为接口；



## IO设备

### 分类

- 块设备：信息的存取总是以数据块为单位，所以存储信息的设备称为块设备。例如：磁盘。特点：
  - 传输速率高
  - 可寻址
  - 可随机读/写任一块

- 字符设备：其传输的基本单位是字符。特点：
  - 传输速率低
  - 不可寻址
  - 在输入／输出时常采用中断驱动方式。

### 常见设备

#### 磁盘

##### 构成

![image-20210913103841769](IO.assets/image-20210913103841769.png)

若系统中有4=2^2^个驱动器，每个驱动器带一个磁盘，每个磁盘256=2^8^个磁道、16=2^4^个盘面，每个盘面划分为16=2^4^个扇区，则==每个扇区地址有18位二进制代码==，格式如下：

![image-20210913104227816](IO.assets/image-20210913104227816.png)

##### 性能指标

- 磁盘容量：一个磁盘所存储的字节总数；

  - 非格式化容量：磁记录表面可以利用的磁化单元总数；
  - 格式化容量：按照==特定的记录格式==能存储信息的总量；
- 记录密度

  - 道密度：磁盘半径方向上磁道数；
  - 位密度：磁道单位长度能记录二进制代码位数
  - 面密度：道密度 X 位密度
- **平均存取时间 = 寻道时间+旋转延迟时间+传输时间**
- 寻道时间 = 启动磁臂时间 + n条磁道 X 磁臂移动速度
  - 旋转时间 = 1 / 2r
    -  r为1分钟可以转几圈；1/r意味着1圈用多长时间 。 
    -  乘1/2意味着取平均
  - 传输时间 = b/rN
    - b/N ：要取数据和一圈数据的占比
    - 1/r：一圈所用的时间
- 数据传输率：磁盘存储器在==单位时间【1秒】==内向主机传送数据的字节数。
- 数据传输率 = rN
  - r：一秒内磁道转几圈
    - N：一圈磁道有多少个字节



##### 硬盘工作原理

磁盘主要操作就是寻址、读盘、写盘。每次操作都是一个块单元。

磁盘属于机械硬盘，读写操作是串行的，不能同一时刻即读又写。



##### 磁盘调度算法 ——  减少寻道时间

在实际的磁盘IO操作中，存取时间和磁盘调度算法密切相关。**调度算法字节决定了寻道时间**，从而决定存取时间。

1. 先来先服务（FCFS）算法
2. 最短寻找时间优先（SSTF）算法
3. 扫描（SCAN)算法[电梯算法]
4. 循环（C-SCAN）算法 ： 返回时直接快速移动到起始端而不服务任何请求。

> 若无特别说明，也可以默认SCAN 算法和C-SCAN 算法为LOOK 和C-LOOK 调度(即磁头移动只需要到达最远端的一个请求即可返回，不需要到达磁盘端点。)



##### 磁盘扇区进行交叉编号，对磁盘片组的不同盘面错位命名 —— 减少旋转延迟时间

![image-20210913112735243](IO.assets/image-20210913112735243.png)



同柱面不同盘面的扇区若能错位编号，连续读／写相邻两个盘面的逻辑记录时也能减少碰头延迟时间。

> 磁盘寻块时间分为三个部分，即寻道时间、延迟时间和传输时间，寻道时间和延迟时间属于＂找＂的时间，凡是＂找＂的时间都可以通过一定的方法削减，但传输时间是磁盘本身性质所决定的，不能通过一定的措施减少。



##### 磁盘的管理

1. 引导块：启动计算机的完整程序
   1. 自举程序：计算机启动时需要运行一个初始化程序，它初始化CPU、寄存器、设备控制器和内存等，接着启动操作系统。为此，该自举程序应找到磁盘上的操作系统内核，装入内存，并转到起始地址，从而开始操作系统的运行。
   2. 自举程序通常保存在ROM 中，为了避免改变自举代码而需要改变ROM 硬件的问题，因此
      只在ROM 中保留很小的自举装入程序，将完整功能的自举程序保存在磁盘的启动块上，启动块位于磁盘的固定位。
   3. 拥有启动分区的磁盘称为启动磁盘或系统磁盘。
2. 坏块：扇区损坏。
   1. 逻辑格式化时不扫描坏块，坏扇区会在FAT上表明
   2. 低级格式化将一些块备用，对操作系统透明。控制器可以用备用块逻辑上提到坏块。
3. 磁盘初始化
   1. 低级格式化：低级格式化是将硬盘划分出柱面和磁道，再将磁道划分为若干个扇区，每个扇区又划分出标识部分ID、间隔区、GAP 和数据区DATA 等。低级格式化是高级格式化之前的一件工作，每块硬盘在出厂前都进行了低级格式化。
      1. 扇区= 头+数据区域【521B】+尾部
      2. 多个柱面组成的分区：C盘、D盘等形式的分区。
   2. （逻辑）高级格式化：清除硬盘上的数据，生成引导信息，初始化FAT表，标注逻辑坏到。
      1. 创建文件系统



##### 廉价冗余磁盘阵列（RAID）

![image-20210913115915512](IO.assets/image-20210913115915512.png)



- RAID0：无冗余、无数据校验的，一块硬盘损坏，数据全无；
- RAID1：一块盘做备份（镜像），磁盘空间利用率50%；
- RAID2：纠错的海明码磁盘阵列。
- RAID3：==位==交叉奇偶校验的磁盘阵列。
- RAID4：==块==交叉奇偶校验的磁盘阵列。
- RAID5：无独立校验奇偶校验的磁盘阵列。



#### 显示器

- 分辨率：所能表示的像素个数。以宽和高的像素数的乘积表示：如800 x 600
- 灰度级：像素点的亮暗差别。灰度级越多，图像越逼真
  - 典型：8位（256级）
- 刷新：光点只能保持极短的时间便会消失，为此必须在光点消失之前再重新扫描显示一遍，
  这个过程称为刷新。
- 刷新频率：一 秒扫描整个屏幕的次数。
- **显示存储器**（VRAM）：也叫刷新存储器，为了不断提高刷新图像的信号，必须把一帧图像信息存储在刷新存储器中。其存储容量由图像分辨率和灰度级决定，分辨率越高，灰度级越多，刷新存储器容量越大。
  - VRAM容量 = 分辨率 x 灰度级位数
  - VRAM带宽 = 分辨率 x 灰度级位数 x 帧频（刷新频率）

## IO设备控制器（接口）

![IO接口基本结构](IO.assets/image-20210913143704633.png)

IO接口的功能：

1. 实现主机和外设的通信联络控制；
2. 进行地址译码和设备选择；
3. 实现数据缓冲；
4. 信号格式的转换；
5. 传送控制命令和状态信息；

IO接口的分类：

- 按数据传送方式
  - 并行接口
  - 串行接口
- 按IO设备的控制方式
  - 程序查询接口
  - 中断结构
  - DMA接口
  - 通道接口
- 按功能选择的灵活性
  - 可编程接口
  - 不可编程接口



> IO端口：接口中可悲CPU直接访问的寄存器。若干端口组成了接口。例如：
>
> - CPU对数据端口可读可写；
> - CPU对状态端口只读；
> - CPU对控制端口只执行写操作；

IO端口编址：

- 统一编制（存储器映射方式）：IO端口当存储器的单元进行编址；
- 独立编地址（IO映射方式）：1/0 端口的地址空间与主存地址空间是两个独立的地址空
  间，因而无法从地址码的形式上区分；





## IO控制方式

> IO系统实现主机与IO设备之间的==数据传送==，可以采用不同的控制方式，各种方式在代价、性能、解决问题的着重点等方面各不相同，常用的1/0 方式有程序查询、程序中断、DMA和通道等。

### 程序直接控制方式(程序查询方式)

![image-20210913145211097](IO.assets/image-20210913145211097.png)

缺点：

- CPU 一旦启动IO, 就必须停止现行程序的运行。（CPU 有＂踏步”等待现象）。
- CPU 与IO是串行工作。



### 程序中断方式



中断分类：

参考：https://e-mailky.github.io/2017-06-07-irq_mechanism2#%E4%B8%89%E6%80%BB%E7%BB%93

![T3](IO.assets/interrupt.jpg)

- 同步中断：当指令执行时由 CPU 控制单元产生，一条指令执行完毕后 CPU 才会发出中断。

- 异步中断：由其他硬件设备依照 CPU 时钟信号随机产生，即意味着中断能够在指令之间发生，例如键盘中断。

|       类别        |        原因         | 同步/异步 |      返回的行为      | 案例     |
| :---------------: | :-----------------: | :-------: | :------------------: | -------- |
|   陷阱（Trap）    |     有意的异常      |   同步    | 总是返回到下一条指令 | 系统调用 |
|   终止（Abort）   |   不可恢复的错误    |   同步    |       不会返回       | 除0      |
|   故障（Fault）   |  潜在可恢复的错误   |   同步    |    返回到当前指令    | 缺页     |
| 中断（Interrupt） | 来自I/O设备的电信号 |   异步    | 总是返回到下一条指令 | IO请求   |

其他中断的分类：

硬中断：硬件发出的中断；

软中断：通过某条指令产生的中断；

内中断：处理器和内存发出的中断；

外中断：IO设备发出的中断；



中断的作用如下：

1. 实现CPU 与1/0 设备的并行工作。
2. 处理硬件故障和软件错误。
3. 实现人机交互，用户干预机器需要用到中断系统。
4. 实现多道程序、分时操作，多道程序的切换需借助千中断系统。
5. 实时处理需要借助中断系统来实现快速响应。
6. 实现应用程序和操作系统（管态程序）的切换，称为“软中断”。
7. 多处理器系统中各处理器之间的信息交流和任务切换。



程序终端示意图：

![image-20210913152102082](IO.assets/image-20210913152102082.png)



中断判断优：

​	中断判优既可以用硬件实现，又可以用软件实现。

- 硬件实现：可以通过硬件排队器实现；
  - 可以设置在CPU中，也可以分散到各个中断源中；
- 软件实现：通过轮询的方式实现。



CPU响应中断的条件：

1. 中断源发出中断请求；
2. CPU允许中断（开中断）；
3. 一条指令执行完毕，且没有更加紧迫的任务；
   1. CPU 响应中断的时间是在每条指令执行阶段的结束时刻。



**中断隐指令**

> 中断隐指令的说明：
>
> 1. 中断隐指令不是一条指令系统中真正的指令；
> 2. 是一种不允许也不可能为用户使用的特殊指令；
> 3. 中断隐指令由硬件直接完成（实现）。
> 4. 说要完成的任务有：关中断+保存断点+引出中断服务程序

- 关中断。不让别的中断所打断的动作叫光中断。
- 保存断点：PC中的内存保存起来；
- ==引出==中断服务程序：将 中断服务程序的==地址==放入PC中。

中断向量：中断服务程序的地址；

- 不同的设备有不同的中断服务程序。

中断向量表：系统会把全部中断向量集中存放到存储器的某个区域内，这个存放中断向量的存储区就称为中断向量表。即中断服务程序入口地址表。

所以：

**中断向量：中断服务程序的入口地址，**

**中断向量地址：是指中断服务程序的入口地址的地址。**



**中断处理过程**

![image-20210913154051624](IO.assets/image-20210913154051624.png)

其中硬件完成的部分是在CPU进入中断周期后，由中断隐指令完成的；



**多重中断和中断屏蔽技术**

![image-20210913154239343](IO.assets/image-20210913154239343.png)

> - 中断嵌套：若CPU 暂停现行的中断服务程序，转去处理新的中断请求，则这种中断称为多重中断，又称中断嵌套。
> - 中断屏蔽技术主要用千多重中断；



CPU 要具备多重中断的功能，必须满足下列条件：

1. 在中断服务程序中提前设置开中断指令。
2. 优先级别高的中断源有权中断优先级别低的中断源。



>  每个中断源都有一个屏蔽触发器:
>  	1 表示屏蔽该中断源的请求;
>  	0 表示可以正常申请;
>
>  屏蔽字寄存器：所有屏蔽触发器组合在一起便构成一个屏蔽字寄存器，屏蔽字：屏蔽字寄存器的内容称为屏蔽字。

![image-20210913154627671](IO.assets/image-20210913154627671.png)

![image-20210913154739275](IO.assets/image-20210913154739275.png)

### DMA方式

>  DMA 方式是一种**完全由硬件进行**成组信息传送的控制方式;
>
>  - 传输的基本单位是数据块。
>  - CPU 与外设并行工作;
>  - DMA 方式在外设与内存之间开辟一条“直接数据通道”,信息传送不再经过CPU, 降低了CPU 在传送数据时的开销，因此称为直接存储器存取方式。
>  - 适用千磁盘机、磁带机等高速设备大批量(块数据)数据的传送.
>  - 在DMA方式中，***中断的作用仅限于故障和正常传送结束时的处理。***
>  - 仅在传送一个或多个数据块的**开始和结束时，才需CPU 干预**，整块数据的传送是在DMA控制器的控制下完成的。

![image-20210913155244846](IO.assets/image-20210913155244846.png)

**DMA的传送方式**

主存和IO设备 之间交换信息时，不通过CPU。但当IO设备和CPU同时访问主存时，可能会发生冲突，为了有效的使用主存，DMA控制器和CPU通常采用以下3中方式使用主存：

1. 停止CPU访问主存：，要求CPU 放弃地址线、数据线和有关控制线的使用权。
2. DMA 与CPU 交替访存：将一个CPU 周期分为C1 和C2 两个周期，其中C1专供DMA 访存，C2 专供CPU 访存。
   1. 适用于CPU 的工作周期比主存存取周期长的情况。
3. 周期挪用（周期窃取）：。IO设备没有DMA 请求时，CPU 按程序的要求访问主存， 一旦IO设备有了DMA 请求，则分3中情况处理：
   1. 此时CPU 不在访存，因此IO的访存请求与CPU 未发生冲突；
   2. CPU 正在访存，此时必须待存取周期结束后，CPU再将总线占有权让出；
   3. 1/0 和CPU 同时请求访存，出现访存冲突，此时**CPU要暂时放弃总线占有权**，由IO设备挪用一个或几个存取周期。



DMA 控制器的功能：

1. **接受外设发出的DMA 请求，并向CPU 发出总线请求。**
2. CPU 响应此总线请求，发出总线响应信号，接管总线控制权，进入DMA 操作周期。 
3. 确定传送数据的主存单元地址及长度，并自动修改主存地址计数和传送长度计数。
4. 规定数据在主存和外设间的传送方向，发出读写等控制信号， 执行数据传送操作。
5. **向CPU 报告DMA 操作的结束。**


### DMA和中断方式的区别

1. 对中断请求的响应只能发生在每条指令执行完毕时（即指令的执行周期后）；而对DMA请求的响应可以发生在每个机器周期结束时（在取指周期、间址周期、执行周期后均可），只要CPU 不占用总线就可被响应。
2. 中断传送过程需要CPU 的干预；而DMA 传送过程不需要CPU 的干预，因此数据传输率非常高，适合千高速外设的成组数据传送。
3. DMA 请求的优先级高千中断请求。
4. 中断方式具有对异常事件的处理能力，而DMA 方式仅局限千传送数据块的IO操作。
5. 从数据传送来看，中断方式靠程序传送， DMA 方式靠硬件传送。

### 通道控制方式

> I/0 通道是指专门负责输入／输出的处理机。
>
> - 通道==没有==自己的内存，通道所执行的通道程序是放在主机的内存中的，也就是说通道与CPU 共享内存。

当CPU 要完成==一组==相关的读（写）操作及有关控制时，只需向I/0 通道==发送一条I/0 指令==，以给出其所要执行的通道程序的首地址和要访问的I/0 设备，通道接到该指令后，执行通道程序便可完成CPU 指定的1/0 任务，数据传送==结束时向CPU 发中断==请求。



### 通道与DMA 方式的区别

1. 数据大小上：
   1. DMA 方式需要CPU 来控制传输的数据块大小、传输的内存位置；
   2. 通道方式中这些信息是由通道控制的。
2. 设备数量上：
   1. 每个DMA 控制器对应==一台==设备与内存传递数据，
   2. 通道可以控制==多台设备==与内存的数据交换。



## IO系统的层次结构

- 用户IO软件：用户可直接调用在用户层提供的、与I/0 操作有关的库函数，对设备进行操作。
- 设备独立性软件（设备无关性）：
  - 执行所有设备的公有操作。
    - 对设备的分配与回收；
    - 将逻辑设备名映射为物理设备名；（逻辑设备表 LUT）
    - 对设备进行保护，禁止用户直接访问设备；
    - 缓冲管理；
    - 差错控制；
    - 提供独立于设备的大小统一的逻辑块，
    - 屏蔽设备之间信息交换单位大小和传输速率的差异。
- 向用户层（或文件层）提供统一接口。无论何种设备，它们向用户所提供的接口应是相同的。
  - 例如：对各种设备的读／写操作，在应用程序中都统一使用read/write 命令等。
- 设备驱动程序。与硬件直接相关；驱动I/0设备工作的驱动程序。
- 中断处理程序：中断处理与硬件紧密相关
- 硬件设备：I/0 设备通常包括一个机械部件（设备本身）和一个电子部件（插入主板扩充槽的印制电路板）【又叫设备控制器（或适配器）】。

![image-20210913170129247](IO.assets/image-20210913170129247.png)

## 设备独立性软件详讲



### IO调度概念

> I/0 调度就是确定一个好的顺序来执行这些I/0 请求。应用程序所发布的系统调用的顺序不一定总是最佳选择，所以需要I/0 调度来改善系统整体性能，使进程之间公平地共享设备访问，减少I/0 完成所需要的平均等待时间。



### 高速缓存与缓冲区

![image-20210913171205023](IO.assets/image-20210913171205023.png)



#### 高速缓存（Cache）

> Cache的目的：高速缓存技术来提高磁盘的I/0 速度；

高速缓存在内存中分为两种形式：

- 一种是在内存中开辟一个单独的存储空间作为磁盘高速缓存，大小固定；
- 另一种是把未利用的内存空间作为一个缓冲池，供请求分页系统和磁盘I/0 时共享。

#### 缓存区（Buffer）

引入缓冲区的目的主要如下：

1. 缓和CPU 与I/0 设备间速嗖不匹配的矛盾。
2. 减少对CPU 的中断频率，放宽对CPU 中断响应时间的限制。
3. 解决基本数据单元大小（即数据粒度）不匹配的问题。
4. 提高CPU 和I/0 设备之间的并行性。

实现方法如下：

- 采用硬件缓冲器，但由千成本太高，除一些关键部位外，一般不采用硬件缓冲器；
- 采用缓冲区（位于内存区域）；



缓冲区的特点：满了才能取，空了才能放；

```c
CPU 对这一块数据处理的时间：C
磁盘把一块数据输入缓冲区的时间：T
冲区中的数据传送到用户区的时间为M
```



1. 单缓冲区处理每块数据的用时为max(C, T) + M；
2. 双缓冲区处理一块数据的用时为max(C+ M, T) ；
3. 循环缓冲：类似循环队列；
4. 缓存池：
   1. ![image-20210913171657276](IO.assets/image-20210913171657276.png)
   2. 当输入进程需要输入数据时，便从空缓冲队列的队首摘下一个空缓冲区，把它作为收容输入工作缓冲区，然后把输入数据输入其中，装满后再将它挂到输入队列队尾。
   3. 当计算进程需要输入数据时，便从输入队列取得一个缓冲区作为提取输入工作缓冲区，计算进程从中提取数据数据用完后再将它挂到空缓冲队列尾。

###  设备分配

设备分配应该考虑的因素：

1. 设备的固有属性
   1. 独占设备
   2. 共享设备：宏观共享，微观交替
   3. 虚拟设备：SPOOLing技术将独占设备改造成共享设备。
2. 设备分配算法
   1. 先来先服务
   2. 优先级高者优先
   3. 短任务优先
   4. ...
3. *设备分配中的安全性*
   1. 安全分配：一段时段每个进程只能使用一个设备
   2. 不安全分配：一个进程可以同时使用多个设备（可能会发生死锁）

#### 设备分配的安全性

静态分配：进程运行前就为其分配全部所需资源

动态分配：进程运行过程中动态申请设备资源



#### 设备分配管理中的数据结构

![image-20210913173344302](IO.assets/image-20210913173344302.png)

> 一个通道可以控制多个设备控制器；
>
> 一个设备控制器可以控制多个设备；



设备分配步骤：

1. 根据进程请求的逻辑设备名查找系统设备表（SDT），根据SDT找到设备控制表（DCT），若设备忙碌就讲进程得出PCB挂在设备等待队列中
   1. 在LUT由逻辑设备名查找==逻辑设备表==找到对应的物理设备名；
2. 根据DCT找到控制器控制表（COCT）。若控制器忙碌则将进程的PCB挂在控制器等待队列中，不忙碌则将控制器分配给进程。
3. 根据COCT找到通道控制表（CHCT），若通道忙碌则将进程PCB挂在通道等待队列中，不忙碌则将通道分配给进程。

只有设备，控制器，通道三者都分配成功，才可以启动IO设备进行数据传送。



- 设备控制表 DCT：每个设备一个DCT（设备的详细信息）
- 控制器控制表 COCT：每个设备控制器都会对应一张COCT
- 通道控制表 CHCT：每个通道都对应一张CHCT
- 系统设备表 SDT：记录系统中全部设备的情况（关键信息），每个设备对应一行数据。
- 逻辑设备表 LUT ：一个系统一张；逻辑设备名和物理设备名的映射。



### SPooLing技术

> SPOOLing 技术：用软件的方式模拟脱机技术。将独占设备改造成共享设备的技术。

SPOOLing 系统的组成：

![image-20210913175350499](IO.assets/image-20210913175350499.png)

共享打印机就是用SPOOLing技术将独占式打印机“虚拟”层共享打印机。



- 输入/出井：模拟脱机输入/输出的磁带；
- 输入/出进程：模拟脱机输入/输出的外围控制机；
- 输入/输出缓存区：内存中的缓冲区（buffer），输入，输出时的“中转站”。起到暂存的作用。
