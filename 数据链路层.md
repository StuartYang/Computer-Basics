# 数据链路层

> 链路（link）：就是从一个节点到相邻节点的一段物理线路，中间没有任何的交换节点。
>
> 数据链路（data link）: 将通信协议的硬件和软件加在链路上，就构成了数据链路。
>
> 数据链路层以==帧==为单位传输和处理数据。

==**点对点信道的数据链路层的三个重要问题**==

- 封装成帧
  - 帧头+IP数据报+帧尾 ； 最大长度为1518 B。
  - ![image-20210903180009167](物理层.assets/image-20210903180009167.png)
- 差错检测
  - 帧在传输过程中可能会出现误码，根据帧尾的检错码就可以检测出帧中是否有误码
  - CRC（循环冗余检测）
- 可靠传输
  - 接受方接受错误帧后，会丢弃。所谓可靠服务，发送发就需要确保接收方还能再次接受到该帧的正确帧。
  - **尽管误码是不能完全避免的，但若能实现发送发发送什么，接收方就能收到什么，就成为可靠传输**



==**广播信道（共享式以太网）的数据链路层的信号碰撞问题**==

- 信号碰撞问题的解决：
  - 有线环境下采用：CSMA/CD
  - 交换式以太网取代
  - 无线环境由于还是采用共享式以太网，采用CSMA/CA解决



==数据链路层的互联设备==

- 网桥和交换机的工作原理
- 集线器（物理层互联设备）与交换机的区别



## 封装成帧

> 封装成帧是指数据链路层给上层交付的协议单元添加帧头和帧尾使其成为帧。
>
> - **帧头和帧尾中包含有重要的控制信息。**
> - 帧的一大功能：==帧定界==
>   - 开头和结尾

>  ***MAC帧与PPP帧的区别 ?***
>
>  回答：我们知道数据链路层的信道分为两种：（点对点信道，广播信道），其中如果在如果是点对点（远程/广域网）信道使用PPP协议；如果是广播信道（一个局域网内）使用MAC帧协议。

接收方的数据链路层如何从物理层交付的比特流中提取出一个个帧呢？

帧的一大功能：==帧定界==；PPP帧的帧头和帧尾中就有1字节的标志尾，用来帧定界。区分不同的帧；但是不同所有的帧都有帧标志尾，例如MAC帧格式中帧头和帧尾中就没有帧定界标志。而mac在在局域网中传输时，**物理层会在MAC前加上8字节的前导码**，前导码中最后1字节是帧开始定界符，前7个是帧同步码，作用是时钟同步；同时还规定了96bit的帧间隔时间。

![image-20210906105525167](数据链路层.assets/image-20210906105525167.png)

为了提高帧的传输效率，应当提高帧的数据部分的长度尽可能大一些。帧的数据部分应当远大于帧头和帧尾；

考虑到差错检测等多因素，每个数据链路层协议都规定来了帧的数据部分长度上限，即最大传送单元MTU。

## 透明传输

> 透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样；
>
> - 上层给什么，数据链路层都可以传过去。不会因为上层数据的特殊性（包含帧定界符）就不传了；
>   - 解决这各特殊性
>     - 面向字节的物理链路使用字节（字符）填充的方式：
>     - 面向比特（HDLC协议）理链路使用0比特填充的方式实现透明传输：在数据中进行遇到5个1就插入1个0；



## 差错检测

- 实际的通信中链路不是理想的，比特在传输过程中可能会产生差错，1可能变成0；
- 在一段时间内，传输**错误的**比特所传输比特总数的比率称作**误码率**BER
- 使用**差错检测码**来检测数据在传输过程中是否产生比特差错，是数据链路层所要解决的重要问题之一。

帧尾中有的FCS字段就是差错检测码；



### 奇偶校验

> 在待发送的数据后面添加1位的校验位，使整个数据（包括所添加的校验位在内）中的“1”的个数为奇数（奇校验）偶（偶校验）；
>
> 如果有**奇数个位 发生误码**，则奇偶校验发送变化，可以**检查出误码**；
>
> 如果有**偶数个位 发生误码**，则奇偶性不发生改变，不能**检查出误码（漏检）**

由于漏检率较高，数据链路层不使用这种方式进行校验。 

## 差错检测

- 循环冗余校验CRC（数据链路层使用这种方式进行校验），*CRC*估计没有*纠错*能力。



## 可靠传输的基本概念

1. 使用**差错检测技术（例如CRC）**，接受方的数据链路层就可检测出帧在传输过程中**是否产生了误码**。
2. 接下如何处理呢？这取决于数据链路层向上层提供的服务类型
   1. **不可靠传输服务：仅仅丢弃误码的帧**，其他的什么也不做；
   2. 可靠传输服务：想办法实现发送发发送什么，接受方就接受什么。

- 一般情况下，**有线链路**的误码率比较低，为了减小开销，并**不要求数据链路层向上提供可靠的传输服务**，即出现了误码，可靠传输的问题由其上层处理。
- **无线链路**容易受到干扰，误码率比较高，所以要**求数据链路层必须向上层提供可靠的传输服务**。

说明：

1. **比特差错**只是传输差错中的一种。
2. 从整个计算机网络体系结构来看，传输差错还包括：**分组丢失、分组失序**以及**分组重复**。
3. 分组丢失，分组失序以及分组重复这些传输差错，一般不会出现在数据链路层，而会穿线在其上层。
   1. 所以可靠传输服务不仅仅局限于数据链路层，其他各层均可选择实现可靠传输。

如果TCP/IP体系中的网络接口层使用802.11无线局域网 ，该协议要求数据链路层实现可靠传输；

如果TCP/IP体系中的网络接口层使用802.11无线局域网 ，该协议要求数据链路层实现可靠传输；

IP协议向上提供无连接，不可靠传输服务

TCP向上提供面向连接的可靠传输服务；

UDP向上提供无连接，不可靠的传输服务；





## 可靠传输的实现机制

### 停止等待协议SW（Stop-and-Wait）—— 自动请求重传协议ARQ

![这里写图片描述](数据链路层.assets/20150916162209455)

>  "停止等待"就是指发送完一个分组就停止发送,等待对方的确认,只有对方确认过,才发送下一个分组。

三种情况：

1. 无差错情况: 发送方发送分组,接收方在规定时间内收到,并且回复确认.发送方再次发送……

2. 超时重传有以下三种情况:（等待时间选取：略大于双方之间的往返时间RTT）

   1. 分组丢失:发送方发送分组,接收方没有收到分组,那么接收方不会发出确认,**只要发送方过一段时间没有收到确认**,就认为刚才的分组丢了,那么发送方就会再次发送.
   2. 确认丢失:发送方发送成功,接收方接收成功,确认分组也被发送,但是分组丢失,**那么到了等待时间,发送方没有收到确认,又会发送分组过去**,此时接收方前面已经收到了分组,那么此时接收方要做的事就是:丢弃分组,重新发送确认.(只需要一个bite就能分辨是否是重复的分组)
   3. 传送延迟:发送方发送成功,接收方接收成功,确认分组也被发送,没有丢失,但是由于传输太慢**, 等到了发送方设置的时间,发送方又会重新发送分组,此时接收方要做的事情: 丢弃分组,重新发送确认 **. **发送方如果收到两个或者多个确认,就停止发送,丢弃其他确认**.

   > 补充：
   >
   > - 确认分组和数据分组都需要编号。（都只需要1个bite即可区分）
   > - 由于数据链路层确认分组一般不会丢失，所以一般无需确认编号。

![这里写图片描述](数据链路层.assets/20150916162234282)

>  停止等待协议的优点是简单,但是**缺点是信道的利用率太低,一次发送一条消息**,使得信道的大部分时间内都是空闲的,为了提高效率,我们采用流水线传输,这就与下面两个协议有关系了.

信道利用率 =  数据分组的发送时间 /  该数据完全被接受的全部时间 



- 当往返时间远大于数据帧发送时延时（例如使用卫星链路），信道利用率非常低。
- 如果出现重传，对于传送有用的数据信息来说，信道利用率还要降低。
- 为了克服停止-等待协议信道利用率很低的确定，就产生了另外两种协议，后退N帧协议（GBN）和选择重传协议（SR）



### 回退N帧协议

- 累计确认，对最近未按有序到达的数据分组，除丢弃外，还要对最近按序接受的数据分组进行确认。
  - 缺点：不能及时反映出接收方已经正确接受的信息；
- 连续收到几个确认分组由具体情况确认
- 发送方只有收到对已发送数据分组的确认时，发送窗口才能向前相应滑动；
- **发送方收到重复确认时，可在重传计时器超时前尽早开始重传，由具体实现决定。**
- 发送方发送窗口内某个已发送的数据分组产生超时重发时，其后续再发送窗口内自己发送的数据分组也必须全部重传，这就是后退N帧协议的由来。

### 选择重传协议



后退N帧协议中 “发送方发送窗口内某个已发送的数据分组产生超时重发时，其后续再发送窗口内自己发送的数据分组也必须全部重传”的特性，这是对信道资源的极大浪费，===\==>选择重传协议

发送窗口的取值范围： 1< W~发~ <= 2^n-1^

接受窗口的取值范围: 1< W~收~ <= W~发~





## PPP协议（点对点信道)

> 点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路层协议。

用户计算机与ISP进行通信时，所使用的数据链路层协议通常就是PPP协议。

在1999年公布的在以太网上运行的PPP协议，即PPP over Ethernet。简称PPPoE，它使得ISP可以通过DSL，电路调制解调器，以太网等宽带接入技术以以太网接口的形式为用户提供接入服务。

同时 PPP协议也是目前最广泛的点对点数据链路层协议。广泛应用于广域网之间的专用线路。

ppp协议为在点对点链路传输各种协议数据报提供了一个标准方法，主要由以下三部分构成：

1. 对各种协议数据报的封装方法；（封装成帧）
2. 链路控制协议LCP。用于建立，配置以及测试数据链路层的连接
3. 一套网络控制协议NCPs，其中的每一个协议支持不同的网络层协议。

PPP协议可在多种类型的点对点链路上运行。

1. 面向字节的异步电路
2. 面向比特的同步电路



![image-20210906152318795](数据链路层.assets/image-20210906152318795.png)

接受方每收到一个PPP帧，就进行CRC检验，若CRC检验正确，就收下这个帧；反之，就丢弃这个帧，使得PPP的数据链路层向上提供**可靠传输服务**。

![image-20210906153743115](数据链路层.assets/image-20210906153743115.png)



## 媒体接入控制（共享信道）

- ==共享信道==要着重考虑的一个问题就是如何协调多个发送和接受站点对一个共享传输媒体的占用，即媒体接入控制MAC（Medium Access Control）

媒体接入控制分类

- 静态划分信道：预先固定分配好信道，这类方法非常不灵活，对于突发性情况数据传输信道利用率会很低，通常在无线电网络的物理层中使用，而不是在数据链路层中使用。
  - 频分多址
  - 时分多址
  - 码分多址
- 动态划分信道
  - 受控制接入：淘汰
    - 集中控制
    - 分散控制
  - 随机接入：解决的问题：如何解决冲突
    - 随着技术的发展，交换式以太网的成熟，具有更高的性能，点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式以太网，但是由于无线信道的广播天性，无线局域网仍然使用共享媒体接入技术。

> 用==集线器==连接的局域网叫共享式局域网，利用==交换机==连接的局域网叫交换式局域网。
>
> 在介绍集线器与交换机二者区别的时候，我们先来谈谈网络中的共享和交换这两个概念。在此，我们打个比方，同样是10个车道的马路，如果没有给道路标清行车路线，那么车辆就只能在无序的状态下抢道或占道通行，容易发生交通堵塞和反向行驶的车辆对撞，使通行能力降低。为了避免上述情况的发生，就需要在道路上标清行车线，保证每一辆车各行其道、互不干扰。共享式网络就相当于前面所讲的无序状态，当数据和用户数量超出一定的限量时，就会造成碰撞冲突，使网络性能衰退。而交换式网络则避免了共享式网络的不足，交换技术的作用便是根据所传递信息包的目的地址，将每一信息包独立地从端口送至目的端口，避免了与其它端口发生碰撞，提高了网络的实际吞吐量。
>
> **交换式以太网中，交换机供给每个用户专用的信息通道，除非两个源端口企图将信息同时发往同一目的端口，否则各个源端口与各自的目的端口之间可同时进行通信而不发生冲突。**



### 静态划分信道（物理层划分技术）

 信道复用

- 频分复用FDM（Frequency Division Multiple）——  频分多址FDMA（Frequency Division Multiple Access）
- 时分复用TDM（Time Division Multiple）——  时分多址TDMA（Time Division Multiple Access）
- 波分复用WDM（Wave Division  Multiple）——  波分多址WDMA（Wave Division  Multiple Access）：光的频分复用
- **码分复用CDM**（Code Division Multiple） ——  码分多址CDMA（Code Division Multiple Access）

>  复用和多址的关系
>
>  - 复用是将单一媒体的频带资源分为很多的子信道，这些子信道相互独立，互不干扰。从媒体的整体频带资源上看，每个子信道只占用该媒体频带资源的一部分。
>  - 多址（更加确切的是多点接入）处理的是**动态分配**信道给用户，这些用户仅仅是暂时性地占用信道的应用中是必须的，而所有的移动通信系统基本上都属于这种情况。相反的，再信道永久的分配给用户的应用中，多址不是需要的。
>  - 某种程度上，TDMA，CDMA....算是FDM，CDM的应用。





### 	（载波监听多址接入/碰撞检测）—— 有线的共享式以太网

- 载波监听CS：每个站在发送之前先检测一下总线上是否有其他站点发送帧（“先听后说”）—— **固定的等待时间**

  - 若检测到总线空闲96bit时间，则发送这个帧；—— 帧间最小间隔
  - 若是检测到总线忙，则继续检测并等待总线转为96bit时间，然后再发送这个帧；

- 多址接入MA：多个站连接在一条总线上，竞争使用总线；

- 碰撞检测CD：每一个正在发送帧的站边发送边检测碰撞（“边说边听”）

  - 一旦发现总线上出现碰撞，则立即停止发送，退避一段时间后再次发送（“一旦冲突，立即停止，等待时机，重新发送”）
  - 以太网还采取一种叫做强制碰撞的措施，这就是单发送帧一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送32bit或者64bit的人为干扰帧，以便于有足够多的碰撞信号使所有站点能检测出碰撞。

- 争用期（碰撞窗口）—— CD中有的

  - 主机最多经过2t的时长就可检测到本次发送是否受到碰撞，所以，以太网端到端往返时延2t称为争用期或者碰撞窗口。
  - 每个主机在自己发送帧之后的一小段时间内，存在着碰撞的可能性，**这一小段时间是不确定的**，它取决另外一个发送帧主机到本主机的距离，但不会超过总线端到端往返时延，即一个争用期。
  - 显然，在共享式以太网中发送帧的主机越多，端到端往返时延越大，发生碰撞的概率就越大，所以，==**共享式以太网不能连接太多的主机，使用的总线也不能太长。**==
    - 100Mb/s的以太网把争用期定位512bit发送时间，即51.2us，因此其总线长度不能超过5120m，但考虑带其他的一些因素，如信号衰减，以太网规定长度不能超过2500m。
    - 最小帧长以太网规定最小帧长为64字节，即512比特（512bit时间即为争用期）
      - 如果要发送的数据非常少，就必须添加一些填充字段，凑够64字节
      - 以太网的最小帧保证了主机可以在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞；
        - 如果在争用期（发送64字节）没有检测到碰撞，那么后续发送的数据一定不会发送碰撞。
        - 如果在争用期内检测碰撞，就立即停止发送，小于64字节的帧都是无效帧。
    - 最大帧长：
      - 以太网MAC帧最大长度为1518字节。
      - 插入VLAN标记后的802.1Q帧最大长度为1522字节。
  - 截断二进制指数退避算法
    - 退避时间 = 基本退避时间 X  随机数r
      - 随机数r从离散整数集合（0,1,2,3...,2^k^-1）中随机选出一个数
        - k = Min[重传次数，10]
    - 退避算法可使重传需要推迟的平均时间随重传次数而增大（这也称为动态退避），因此减小发生碰撞的概率，有利于整个系统的稳定。
    - 但重传次数达到16次仍不能成功时，表明同时打算发送帧的主句太多，以至于连续发送碰撞，则丢失该帧，并向高层报告。
  - 信道利用率
    - 理想情况下，不发生碰撞 下： 极限信道利用率 信道利用率 = T~0~ / （T~0~+t）
      - To： 帧s的发送时延迟
      - t：最后一个帧的传播延迟
      - 说明：以太网端到端的距离应当受到限制，不应太长；帧长应该尽量大。

  

  注：每台计算机一次只允许发送一个包，所有计算机在试图再一次发送数据之前 ，必须在最近一次发送后等待9.6微秒（以10Mbps运行）。

### CSMA/CA

无线局域网中不适用CSMA/CD的原因：

- 无线网卡上接受到的信号强度往往会**远远小于**发送信号强度，如果在无线网卡上实现碰撞检测CD，对硬件要求会非常高。
- 由于无线局域网中存在隐蔽站问题，进行碰撞检测的意义也不大。

![image-20210906172839197](数据链路层.assets/image-20210906172839197.png)

>  A和C同时都给B传信息，A对于C而言就是隐蔽站。



CA：碰撞避免。

- 由于不可能避免所有的碰撞，并且**无线信道误码率较高**，802.11还使用了**数据链路层确认机制（停止-等待协议）**来保证数据被正确接受。
- 802.11的MAC层标准定义了两种不同的CSMA/CD媒体接入控制方式：
  - 分布式协调功能DCF：
  - 点协调功能PCF；



所有站点必须在持续监测到信道空闲一段指定时间后才能发送帧。这段时间就是帧间间隔IFS。

帧间间隔的长短取决于该站点要发送的帧的类型：

- 高优先级帧需要等待的时间较短，可优先发送；
- 高优先级帧需要等待的时间较短，可推迟发送；

常见的两种**帧间间隔**：

1. 短帧间间隔SIFS（28us）：是最短的帧间间隔，用来分隔开一次对话的各帧。一个站点能够在这段时间内由发送方切换到接受方。使用SIFS的帧类型有
   1. ACK帧
   2. CTS帧(在后面“对信道进行预约”中介绍)
   3. 由过长的MAC帧分片后的数据帧
   4. 以及所有回答AP探询的帧
   5. 在PCF方式中接入点AP发送出的任何帧。
2. DCF帧间间隔DIFS（128us）：DIFS用来发送数据帧和管理帧。  



工作原理：

1. 源站发现信道空闲，再等待DIFS，开始发送数据帧
   1. 为什么要等待DIFS：考虑到其他站可能存在高优先级的帧要发送，如果有，就让高优先级的帧向发送
2. 目的站收到数据帧后，等待SIFS，开始发送ACK
   1. 为什么等多个待SIFS：用来分隔开一次对话中的各帧
3. 其他站再检测到信道忙后，**等待DIFS，再退避一段随机时间后**，发送新的对话的帧
   1. 为什么还要退避一段随机时间：避免检测到信道空闲后，所有站点同时发送数据。

必须使用退避算法的情况：

1. 在发送数据帧之前检测到信道处于忙状态时；
2. 在每次重传一个数据帧时；
3. 在每一次成功发送一个帧后，要连续发送下一个帧时（这是为了避免一个站点长时间占用信道）。



CSMA/CA的退避算法：



CSMA/CA协议的信道预约和虚拟载波监听

1. 为了尽可能减少碰撞和降低碰撞的影响，802.11标准允许要发送的站点对信道进行预约
   1. 源站发送数据帧之前先发送一个较短的帧，叫做**请求发送RTS**	
      1. 如果RTS帧发生碰撞，源站就收不到CTS帧，需执行退避算法重传RTS帧。
   2. 如果目的站正确收到源站发来的RTS帧，且媒体空闲，就发送一个响应控制帧，叫做允许发送CTS
   3. 除了源站，其他各站收到CTS帧（或数据帧）就推迟接入无线互联网中，保证了源站和目的站不会收到干扰



除了RTS帧和CTS帧会携带通信持续的时间，数据帧也能携带通信需要持续的时间，这称作802.11的==虚拟载波监听==机制。

**其他站点只要监听到RTS帧和CTS帧或数据帧其中任一个就能知道信道被占用多长时间**。而不需要真正监听到信道上的信号，因此虚拟载波监听能减少隐蔽站带来的碰撞问题。



CSMA/CA还使用了停止等待协议。







## MAC地址，IP地址和ARP协议——共享式以太网

## ARP协议



### MAC地址

> 当多个主机连接在同一个==广播信道==上，要想实现两个主机之间的通信，则每个主机都必须有唯一的标识，即数据链路层地址。
>
> 在每个主机发送的帧必须要携带发送主机和接受主机的地址。由于这类地址是用于媒体接入控制MAC，所以这类地址叫做MAC地址。

MAC地址一般固话在网卡的电可擦只读存储器EEROM上，所以MAC地址称作硬件地址。

MAC地址有时也被成为硬件地址。

用户主机一般配有两个网络适配器，有线局域网适配器（有线网卡）和无线及局域网适配器（无线网卡）。严格来说，==MAC地址是对网络上各接口的唯一标识，而不是对网络各设备的唯一标识。==



MAC地址 48个bit（6字节），前24位是由生产网卡的厂商向IEEE申请的厂商地址。后24位由厂商自行分配。

第一字节 最后一位：

- 0：单播
- 1：多播（主播）

第一字节 倒数第二位：

- 0：全球管理
- 1：本地管理

48bit全1，该MAC地址表示广播地址。

- 00 ：全球管理的单播地址：硬件上固化在上面的
- 01：全球管理的组播地址：设备支持的多播地址，用于特定功能，例如交换机生成树协议需要的多播地址
- 10：本地管理的单播地址：由于网络管理员分配，类似自定义，这种地址会覆盖全球管理的单播地址
- 11：本地管理的组播地址：用于用户对主机进行软件配置，以表明其属于哪个多播组。



生活中每个接口就由一个MAC地址：蓝牙，路由器接口。。。。

MAC地址的发送顺序：

- 字节发送顺序：第一字节——> 第六字节
- 字节内的比特发送顺序：b0——> b7



单MAC地址的作用（在共享以太网中）



快速判断是不是多播地址的方法：最高字节的最后二个16进制数不能整除2，就是多播地址。



### IP地址

> IP地址是因特网上主机和路由器所使用的地址，用于表示两个部分；
>
> - 网络编号：标识因特网数以百计的网络
> - 主机编号：标识统一网络上不同主机（或路由器各接口）

很显然，之前介绍的MAC地址不具备区分不同网络的功能。

- 如果只是一个单独的网络，不接入因特网，可以只是用MAC地址。
- 如果主机要接入网络是因特网，就需要IP地址。

在数据报在因特网上转发过程中，

- 源IP地址和目的IP地址保持不变。
- ==源MAC地址和目的MAC地址逐个链路（逐个网络）改变。==





在传输过程中，主机和路由器中都只是知道了下一跳的IP地址（查询路由表）是多少，却不知道MAC地址是多少，这就需要ARP协议。



### ARP协议（Address Resolution Protocol(地址解析协议)）



IP地址———— ？————>MAC地址

- **ARP 只用于 IPv4 协议中**，IPv6 协议使用的是 Neighbor Discovery Protocol，译为邻居发现协议，它被纳入 ICMPv6 中。

每台主句都有一个ARP的高速缓存表。

工作在网络层（路由器）

1. ARP缓存表中没找到
2. 发送ARP广播报文封装在MAC帧中，目的MAC地址为全F。
   1. 广播报文只能在共享式以太网中扩散，即不出路由器。
3. 对方主机收到广播帧后，交给上层
   1. 如果不是自己的MAC地址，不予理会
   2. 如果是自己的MAC地址，响应。
      1. 将源站的IP地址和MAC地址记录到自己的ARP缓存表中；
      2. 给源站发送ARP响应（单播帧），以告知自己的MAC地址。
         1. 所有的主机都可以收到
         2. 不是发送给自己的就

ARP只能在一个网络中使用，不能跨网络使用

ARP记录的两种获取方式

- 动态：自动获取，生命周期默认两分钟（过期自动删除）
- 静态：手工配置，不同操作系统下生命周期不同。



ARP没有验证机制，存在ARP欺骗，攻击等问题。



## 集线器和交换机

早期的总线型以太网

使用双绞线和集线器HUB的星型以太网

- 物理拓扑是星型，逻辑上是总线型的，各个站点，使用的还是CSMA/CD协议（由于CSMA/CD协议协调信道的归属权），只能工作在半双工模式下。
- 集线器只是物理层，它的每个接口仅简单地转发比特，不进行碰撞检测（由各站的网卡检测）
- 集线器一般有少量的容错功能和网络管理功能。
- 不能隔离广播域（碰撞域），也不能隔离冲突域（信道归属权）
- 用集线器扩展，会扩展碰撞域。
- 集线器发送单播帧，会传播到各个主机，由各个主机判断是否发送给自己的帧。

使用集线器HUB可以在物理层扩展以太网。



以太网交换机

- 判断帧地址
- 以太网交换机发送单播帧，会有交换机判断是发送给那个主机的帧。
- 交换机有多个接口，每个接口都可以直接与一台主机或另一台以太网交换机相联，一般工作在==全双工方式下==。
- 以太网交换机具有并行性，能同时连通多对接口，使多对主机能同时通信，无碰撞（不适用CSMA/CD）。
- 以太网==交换机一般都具有多种速率的接口==，例如：10Mb/s，100Mb/s，1Gb/s，10Gb/s接口的多种组合。
- 以太网交换机工作在数据链路层（也包括物理层），它收到帧后，在帧交换表中查找帧的目的MAC地址所对应的接口号，然后通过该接口转发帧。
  - 帧交换地址
- 以太网交换机是一种即插即用的设备，其内部的帧交换表是通过==自学习算法==自动地建立起来的。
- 可以打错冲突域，不能打破广播域；
- 用交换机扩展，只会扩展广播域。

帧的两种转发方式：

1. 存储转发
2. 直通交换：采用基于硬件的交叉矩阵（交换时延小，不需要检查帧是否有差错【没有校验码】）



### 以太网交换机自学习和转发帧的流程

- 以太网交换机工作在数据链路层（也包括物理层）



==假设各主机知道网络中其他各**主机**的MAC地址（无需ARP），但是交换机不清楚，所以就需要以太网交换机自学习==



A--->B  进入交换机1  

1. 在交换机1的表中查该MAC地址
   1. 没找到，登记一下（ A的MAC地址，进入交换的端口号1），**泛洪（盲目转发）**【除了进入口，其他口都转发】
      1. 登记的是来源，不登记去处
   2. 找到了，按表转发

表中的每条记录都有有效时间，到期自动删除。





## 以太网交换的生成树协议STP

- 如何提高以太网的可靠性？

> 通过添加==冗余链路==的方式提高以太网的可靠性；
>
> - 冗余链路会带来负面效应：形成网络环路
>   - **网络环路**会带来以下问题：
>     - ==**广播**风暴==：大量消耗网络资源，使得网络无法正常转发其他数据帧
>     - 主机收到重复的广播帧：大量消耗主机资源
>     - 交换机的帧交换表震荡（漂移）
>       - 广播帧进入帧转发表中也是需要登记的。		

什么是广播风暴：

> 指当广播数据充斥网络无法处理，并占用大量网络带宽，导致正常业务不能运行，甚至彻底瘫痪，这就发生了“广播风暴”。



为了增加冗余链路增加可靠性的同时，也避免因为网络环路造成的影响，从而有了生成树协议STP（Spanning Tree Protocol）



生成树STP：不论交换机采用怎样的物理连接，**交换机都能自动计算并构建一个逻辑上没有环路的网络**，其拓扑结构必须是树型的（无逻辑环路）



- 生成树协议只是应用于交换机与交换机之间，和主机没关系。
- 最终生成的树型逻辑拓扑要确保连通整个网络；
- 当连接交换机或网络==物理拓扑发生变化==时（有可能是人为改变或故障），交换机都将进行==生成树的重新计算==
  - 采用生成树算法（数据结构）



## VLAN（虚拟局域网）

- 以太网只能工作在数据链路层（也包括物理层）
- 使用一个或多个以太网交换机互连起来的交换机以太网，其所有站点都属于同一个广播域
- 随着交换机以太网规模越来越大，广播域相应扩大。
- **巨大的广播域**会带来很多弊端：
  - 广播风暴
    - ARP的广播请求会传遍整个广播域
  - 难以管理和维护
  - 潜在的安全问题

使用路由器就能隔离广播域，但是路由器成本较高，从而虚拟局域网（VLAN）技术应运而生。



> VLAN是一种将局域网内的设备划分成与物理位置无关的逻辑组的技术，这些逻辑组具有某些共同需求。

同一个vlan之间可以广播通信，不同vlan之间不能广播通信。



### VLAN的实现机制

vlan在交换机上实现的



IEEE802.1Q帧，对MAC帧进行了扩展标记，插入了4字节的VLAN标记（VID），它唯一的标识了以太网帧属于哪个vlan。

802.1Q帧是由交换机处理的，不是由用户处理的。

- 当交换机收到普通的以太网帧时，会将其打标签（插入4字节的VLAN标记将其变成802.1Q帧）
- 当交换机转发802.1Q帧时，==可能==会删除4字节的VLAN标记将其变成普通的以太网帧（MAC帧）。



交换机的端口类型：

1. Access
   1. 用于连接用户计算机
   2. access端口只属于一个VLAN
   3. Access端口只属于一个VLAN（默认为1）
   4. 用户发出的直接普通以太网MAC帧，根据接受帧的端口的PVID给帧==“打标签”==
   5. 外部传来的数据帧中的vid和某端口的PVID相等，则去标签并转发该帧给用户主机。
2. Trunk
   1. TRunk端口用于交换机自己亲啊或交换机与路由器之间的互联
   2. Trunk端口可以属于多个Vlan
   3. 用户可以设置Trunk端口的PVID值，默认情况下，TRunk的PVID为1。
   4. 作用
      1. 处理发送帧的方法：
         1. 对VID = PVID的帧：“去标签转发”
         2. 对VID ！= PVID的帧： 直接转发
      2. 处理接受帧的方法：
         1. 对未打标签的帧，进行打标签
         2. 字节接受打了标签的帧
3. Hybrid
   1. 即可用于交换机之间或与路由器之间，也可用于交换机与用户计算机之间。
   2. Hybrid可以用于多个VLAN（TRunk）
   3. Hybrid端口发送帧处理方法：
      1. 查看帧的VLID是否在端口的“去标签”列表（列表中配置多个VID）中：（不同于Trunk）
         1. 存在，则“去标签”后再转发
         2. 不存在，则直接转发
      2. 接受帧的方法（同TRunk）

交换机各端口的缺省VLAN ID

- 在思科交换机上称为 Native VLAN，即本征VLAN
- 在华为交换机上称为Port VLAN ID，即端口VLAN ID，简称为PVID
- 每个端口有且仅有一个PVID

