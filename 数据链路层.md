# 数据链路层

> 链路（link）：就是从一个节点到相邻节点的一段物理线路，中间没有任何的交换节点。
>
> 数据链路（data link）: 将通信协议的硬件和软件加在链路上，就构成了数据链路。
>
> 数据链路层以==帧==为单位传输和处理数据。

==**点对点信道的数据链路层的三个重要问题**==

- 封装成帧
  - 帧头+IP数据报+帧尾 ； 最大长度为1518 B。
  - ![image-20210903180009167](物理层.assets/image-20210903180009167.png)
- 差错检测
  - 帧在传输过程中可能会出现误码，根据帧尾的检错码就可以检测出帧中是否有误码
  - CRC（循环冗余检测）
- 可靠传输
  - 接受方接受错误帧后，会丢弃。所谓可靠服务，发送发就需要确保接收方还能再次接受到该帧的正确帧。
  - **尽管误码是不能完全避免的，但若能实现发送发发送什么，接收方就能收到什么，就成为可靠传输**



==**广播信道（共享式以太网）的数据链路层的信号碰撞问题**==

- 信号碰撞问题的解决：
  - 有线环境下采用：CSMA/CD
  - 交换式以太网取代
  - 无线环境由于还是采用共享式以太网，采用CSMA/CA解决



==数据链路层的互联设备==

- 网桥和交换机的工作原理
- 集线器（物理层互联设备）与交换机的区别



## 封装成帧

> 封装成帧是指数据链路层给上层交付的协议单元添加帧头和帧尾使其成为帧。
>
> - **帧头和帧尾中包含有重要的控制信息。**
> - 帧的一大功能：==帧定界==
>   - 开头和结尾

>  ***MAC帧与PPP帧的区别 ?***
>
> 回答：我们知道数据链路层的信道分为两种：（点对点信道，广播信道），其中如果在如果是点对点（远程/广域网）信道使用PPP协议；如果是广播信道（一个局域网内）使用MAC帧协议。

接收方的数据链路层如何从物理层交付的比特流中提取出一个个帧呢？

帧的一大功能：==帧定界==；PPP帧的帧头和帧尾中就有1字节的标志尾，用来帧定界。区分不同的帧；但是不同所有的帧都有帧标志尾，例如MAC帧格式中帧头和帧尾中就没有帧定界标志。而mac在在局域网中传输时，**物理层会在MAC前加上8字节的前导码**，前导码中最后1字节是帧开始定界符，前7个是帧同步码，作用是时钟同步；同时还规定了96bit的帧间隔时间。

![image-20210906105525167](数据链路层.assets/image-20210906105525167.png)

为了提高帧的传输效率，应当提高帧的数据部分的长度尽可能大一些。帧的数据部分应当远大于帧头和帧尾；

考虑到差错检测等多因素，每个数据链路层协议都规定来了帧的数据部分长度上限，即最大传送单元MTU。

## 透明传输

> 透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样；
>
> - 上层给什么，数据链路层都可以传过去。不会因为上层数据的特殊性（包含帧定界符）就不传了；
>   - 解决这各特殊性
>     - 面向字节的物理链路使用字节（字符）填充的方式：
>     - 面向比特（HDLC协议）理链路使用0比特填充的方式实现透明传输：在数据中进行遇到5个1就插入1个0；



## 差错检测

- 实际的通信中链路不是理想的，比特在传输过程中可能会产生差错，1可能变成0；
- 在一段时间内，传输**错误的**比特所传输比特总数的比率称作**误码率**BER
- 使用**差错检测码**来检测数据在传输过程中是否产生比特差错，是数据链路层所要解决的重要问题之一。

帧尾中有的FCS字段就是差错检测码；



### 奇偶校验

> 在待发送的数据后面添加1位的校验位，使整个数据（包括所添加的校验位在内）中的“1”的个数为奇数（奇校验）偶（偶校验）；
>
> 如果有**奇数个位 发生误码**，则奇偶校验发送变化，可以**检查出误码**；
>
> 如果有**偶数个位 发生误码**，则奇偶性不发生改变，不能**检查出误码（漏检）**

由于漏检率较高，数据链路层不使用这种方式进行校验。 

## 差错检测

- 循环冗余校验CRC（数据链路层使用这种方式进行校验），*CRC*估计没有*纠错*能力。



## 可靠传输的基本概念

1. 使用**差错检测技术（例如CRC）**，接受方的数据链路层就可检测出帧在传输过程中**是否产生了误码**。
2. 接下如何处理呢？这取决于数据链路层向上层提供的服务类型
   1. **不可靠传输服务：仅仅丢弃误码的帧**，其他的什么也不做；
   2. 可靠传输服务：想办法实现发送发发送什么，接受方就接受什么。

- 一般情况下，**有线链路**的误码率比较低，为了减小开销，并**不要求数据链路层向上提供可靠的传输服务**，即出现了误码，可靠传输的问题由其上层处理。
- **无线链路**容易受到干扰，误码率比较高，所以要**求数据链路层必须向上层提供可靠的传输服务**。

说明：

1. **比特差错**只是传输差错中的一种。
2. 从整个计算机网络体系结构来看，传输差错还包括：**分组丢失、分组失序**以及**分组重复**。
3. 分组丢失，分组失序以及分组重复这些传输差错，一般不会出现在数据链路层，而会穿线在其上层。
   1. 所以可靠传输服务不仅仅局限于数据链路层，其他各层均可选择实现可靠传输。

如果TCP/IP体系中的网络接口层使用802.11无线局域网 ，该协议要求数据链路层实现可靠传输；

如果TCP/IP体系中的网络接口层使用802.11无线局域网 ，该协议要求数据链路层实现可靠传输；

IP协议向上提供无连接，不可靠传输服务

TCP向上提供面向连接的可靠传输服务；

UDP向上提供无连接，不可靠的传输服务；





## 可靠传输的实现机制

### 停止等待协议SW（Stop-and-Wait）—— 自动请求重传协议ARQ

![这里写图片描述](数据链路层.assets/20150916162209455)

>  "停止等待"就是指发送完一个分组就停止发送,等待对方的确认,只有对方确认过,才发送下一个分组。

三种情况：

1. 无差错情况: 发送方发送分组,接收方在规定时间内收到,并且回复确认.发送方再次发送……

2. 超时重传有以下三种情况:（等待时间选取：略大于双方之间的往返时间RTT）

   1. 分组丢失:发送方发送分组,接收方没有收到分组,那么接收方不会发出确认,**只要发送方过一段时间没有收到确认**,就认为刚才的分组丢了,那么发送方就会再次发送.
   2. 确认丢失:发送方发送成功,接收方接收成功,确认分组也被发送,但是分组丢失,**那么到了等待时间,发送方没有收到确认,又会发送分组过去**,此时接收方前面已经收到了分组,那么此时接收方要做的事就是:丢弃分组,重新发送确认.(只需要一个bite就能分辨是否是重复的分组)
   3. 传送延迟:发送方发送成功,接收方接收成功,确认分组也被发送,没有丢失,但是由于传输太慢**, 等到了发送方设置的时间,发送方又会重新发送分组,此时接收方要做的事情: 丢弃分组,重新发送确认 **. **发送方如果收到两个或者多个确认,就停止发送,丢弃其他确认**.

   > 补充：
   >
   > - 确认分组和数据分组都需要编号。（都只需要1个bite即可区分）
   > - 由于数据链路层确认分组一般不会丢失，所以一般无需确认编号。

![这里写图片描述](数据链路层.assets/20150916162234282)

>  停止等待协议的优点是简单,但是**缺点是信道的利用率太低,一次发送一条消息**,使得信道的大部分时间内都是空闲的,为了提高效率,我们采用流水线传输,这就与下面两个协议有关系了.

信道利用率 =  数据分组的发送时间 /  该数据完全被接受的全部时间 



- 当往返时间远大于数据帧发送时延时（例如使用卫星链路），信道利用率非常低。
- 如果出现重传，对于传送有用的数据信息来说，信道利用率还要降低。
- 为了克服停止-等待协议信道利用率很低的确定，就产生了另外两种协议，后退N帧协议（GBN）和选择重传协议（SR）



### 回退N帧协议

- 累计确认，对最近未按有序到达的数据分组，除丢弃外，还要对最近按序接受的数据分组进行确认。
  - 缺点：不能及时反映出接收方已经正确接受的信息；
- 连续收到几个确认分组由具体情况确认
- 发送方只有收到对已发送数据分组的确认时，发送窗口才能向前相应滑动；
- **发送方收到重复确认时，可在重传计时器超时前尽早开始重传，由具体实现决定。**
- 发送方发送窗口内某个已发送的数据分组产生超时重发时，其后续再发送窗口内自己发送的数据分组也必须全部重传，这就是后退N帧协议的由来。

### 选择重传协议



后退N帧协议中 “发送方发送窗口内某个已发送的数据分组产生超时重发时，其后续再发送窗口内自己发送的数据分组也必须全部重传”的特性，这是对信道资源的极大浪费，===\==>选择重传协议

发送窗口的取值范围： 1< W~发~ <= 2^n-1^

接受窗口的取值范围: 1< W~收~ <= W~发~





## PPP协议（点对点信道)

> 点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路层协议。

用户计算机与ISP进行通信时，所使用的数据链路层协议通常就是PPP协议。

在1999年公布的在以太网上运行的PPP协议，即PPP over Ethernet。简称PPPoE，它使得ISP可以通过DSL，电路调制解调器，以太网等宽带接入技术以以太网接口的形式为用户提供接入服务。

同时 PPP协议也是目前最广泛的点对点数据链路层协议。广泛应用于广域网之间的专用线路。

ppp协议为在点对点链路传输各种协议数据报提供了一个标准方法，主要由以下三部分构成：

1. 对各种协议数据报的封装方法；（封装成帧）
2. 链路控制协议LCP。用于建立，配置以及测试数据链路层的连接
3. 一套网络控制协议NCPs，其中的每一个协议支持不同的网络层协议。

PPP协议可在多种类型的点对点链路上运行。

1. 面向字节的异步电路
2. 面向比特的同步电路



![image-20210906152318795](数据链路层.assets/image-20210906152318795.png)

接受方每收到一个PPP帧，就进行CRC检验，若CRC检验正确，就收下这个帧；反之，就丢弃这个帧，使得PPP的数据链路层向上提供**可靠传输服务**。

![image-20210906153743115](数据链路层.assets/image-20210906153743115.png)



## 媒体接入控制（共享信道）

- ==共享信道==要着重考虑的一个问题就是如何协调多个发送和接受站点对一个共享传输媒体的占用，即媒体接入控制MAC（Medium Access Control）

媒体接入控制分类

- 静态划分信道：预先固定分配好信道，这类方法非常不灵活，对于突发性情况数据传输信道利用率会很低，通常在无线电网络的物理层中使用，而不是在数据链路层中使用。
  - 频分多址
  - 时分多址
  - 码分多址
- 动态划分信道
  - 受控制接入：淘汰
    - 集中控制
    - 分散控制
  - 随机接入：解决的问题：如何解决冲突
    - 随着技术的发展，交换式以太网的成熟，具有更高的性能，点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式以太网，但是由于无线信道的广播天性，无线局域网仍然使用共享媒体接入技术。

> 用集线器连接的局域网叫共享式局域网，利用交换机连接的局域网叫交换式局域网。
>
> 在介绍集线器与交换机二者区别的时候，我们先来谈谈网络中的共享和交换这两个概念。在此，我们打个比方，同样是10个车道的马路，如果没有给道路标清行车路线，那么车辆就只能在无序的状态下抢道或占道通行，容易发生交通堵塞和反向行驶的车辆对撞，使通行能力降低。为了避免上述情况的发生，就需要在道路上标清行车线，保证每一辆车各行其道、互不干扰。共享式网络就相当于前面所讲的无序状态，当数据和用户数量超出一定的限量时，就会造成碰撞冲突，使网络性能衰退。而交换式网络则避免了共享式网络的不足，交换技术的作用便是根据所传递信息包的目的地址，将每一信息包独立地从端口送至目的端口，避免了与其它端口发生碰撞，提高了网络的实际吞吐量。
>
> **交换式以太网中，交换机供给每个用户专用的信息通道，除非两个源端口企图将信息同时发往同一目的端口，否则各个源端口与各自的目的端口之间可同时进行通信而不发生冲突。**



### 静态划分信道

 信道复用

- 频分复用FDM（Frequency Division Multiple）——  频分多址FDMA（Frequency Division Multiple Access）
- 时分复用TDM（Time Division Multiple）——  时分多址TDMA（Time Division Multiple Access）
- 波分复用WDM（Wave Division  Multiple）——  波分多址WDMA（Wave Division  Multiple Access）：光的频分复用
- **码分复用CDM**（Code Division Multiple） ——  码分多址CDMA（Code Division Multiple Access）

>  复用和多址的关系
>
> - 复用是将单一媒体的频带资源分为很多的子信道，这些子信道相互独立，互不干扰。从媒体的整体频带资源上看，每个子信道只占用该媒体频带资源的一部分。
> - 多址（更加确切的是多点接入）处理的是**动态分配**信道给用户，这些用户仅仅是暂时性地占用信道的应用中是必须的，而所有的移动通信系统基本上都属于这种情况。相反的，再信道永久的分配给用户的应用中，多址不是需要的。
> - 某种程度上，TDMA，CDMA....算是FDM，CDM的应用。





### 	（载波监听多址接入/碰撞检测）—— 有线的共享式以太网

- 载波监听CS：每个站在发送之前先检测一下总线上是否有其他站点发送帧（“先听后说”）—— **固定的等待时间**

  - 若检测到总线空闲96bit时间，则发送这个帧；—— 帧间最小间隔
  - 若是检测到总线忙，则继续检测并等待总线转为96bit时间，然后再发送这个帧；

- 多址接入MA：多个站连接在一条总线上，竞争使用总线；

- 碰撞检测CD：每一个正在发送帧的站边发送边检测碰撞（“边说边听”）

  - 一旦发现总线上出现碰撞，则立即停止发送，退避一段时间后再次发送（“一旦冲突，立即停止，等待时机，重新发送”）
  - 以太网还采取一种叫做强制碰撞的措施，这就是单发送帧一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送32bit或者64bit的人为干扰帧，以便于有足够多的碰撞信号使所有站点能检测出碰撞。

- 争用期（碰撞窗口）—— CD中有的

  - 主机最多经过2t的时长就可检测到本次发送是否受到碰撞，所以，以太网端到端往返时延2t称为争用期或者碰撞窗口。
  - 每个主机在自己发送帧之后的一小段时间内，存在着碰撞的可能性，**这一小段时间是不确定的**，它取决另外一个发送帧主机到本主机的距离，但不会超过总线端到端往返时延，即一个争用期。
  - 显然，在共享式以太网中发送帧的主机越多，端到端往返时延越大，发生碰撞的概率就越大，所以，==**共享式以太网不能连接太多的主机，使用的总线也不能太长。**==
    - 100Mb/s的以太网把争用期定位512bit发送时间，即51.2us，因此其总线长度不能超过5120m，但考虑带其他的一些因素，如信号衰减，以太网规定长度不能超过2500m。
    - 最小帧长以太网规定最小帧长为64字节，即512比特（512bit时间即为争用期）
      - 如果要发送的数据非常少，就必须添加一些填充字段，凑够64字节
      - 以太网的最小帧保证了主机可以在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞；
        - 如果在争用期（发送64字节）没有检测到碰撞，那么后续发送的数据一定不会发送碰撞。
        - 如果在争用期内检测碰撞，就立即停止发送，小于64字节的帧都是无效帧。
    - 最大帧长：
      - 以太网MAC帧最大长度为1518字节。
      - 插入VLAN标记后的802.1Q帧最大长度为1522字节。
  - 截断二进制指数退避算法
    - 退避时间 = 基本退避时间 X  随机数r
      - 随机数r从离散整数集合（0,1,2,3...,2^k^-1）中随机选出一个数
        - k = Min[重传次数，10]
    - 退避算法可使重传需要推迟的平均时间随重传次数而增大（这也称为动态退避），因此减小发生碰撞的概率，有利于整个系统的稳定。
    - 但重传次数达到16次仍不能成功时，表明同时打算发送帧的主句太多，以至于连续发送碰撞，则丢失该帧，并向高层报告。
  - 信道利用率
    - 理想情况下，不发生碰撞 下： 极限信道利用率 信道利用率 = T~0~ / （T~0~+t）
      - To： 帧s的发送时延迟
      - t：最后一个帧的传播延迟
      - 说明：以太网端到端的距离应当受到限制，不应太长；帧长应该尽量大。

  

### CSMA/CA

无线局域网中不适用CSMA/CD的原因：

- 无线网卡上接受到的信号强度往往会**远远小于**发送信号强度，如果在无线网卡上实现碰撞检测CD，对硬件要求会非常高。
- 由于无线局域网中存在隐蔽站问题，进行碰撞检测的意义也不大。

![image-20210906172839197](数据链路层.assets/image-20210906172839197.png)

>  A和C同时都给B传信息，A对于C而言就是隐蔽站。



CA：碰撞避免。

- 由于不可能避免所有的碰撞，并且**无线信道误码率较高**，802.11还使用了**数据链路层确认机制（停止-等待协议）**来保证数据被正确接受。
- 802.11的MAC层标准定义了两种不同的媒体接入控制方式：
  - 分布式协调功能DCF：
  - 点协调功能PCF









## MAC地址，IP地址和ARP协议——共享式以太网

ARP：MAC地址找IP地址。

MAC地址对于网络上各个接口的唯一标识，而不是对网络上各设备的唯一标识。



mac地址有4种：

- 
