## 概述

网络层的主要任务是==实现网络互连==，进而实现数据包在各网络之间的传输。

要实现网络层的任务，需要解决一下主要问题：

1. 网络层向运输层提供怎样的服务（“可靠传输”或“不可靠传输”）
2. 网络层寻址问题
3. 路由选择问题



因特网是目前全世界用户数量最多的互联网，它使用TCP/IP协议栈。

由于TCP/IP协议栈的网络层使用网络协议IP，它是整个协议的核心协议，所以在TCP/IP协议栈中网络层常常被称作网际层。所以我们通过学习TCP/IP协议栈的网际层来学习网络层的理论知识和时间技术。



## 网际层协议

IP协议，ARP协议，ICMP，IGMP，OSPF，



## 网络层可以提供的两种服务



1. 面向连接的**虚电路服务**
   1. 由于TCP/IP体系结构的因特网的网际层提供的是最简单地，无连接的，尽最大努力交付的数据报服务，所以本章主要围绕因特网网际层如何传输IP数据报这个主题进行讨论。 
2. 无连接的**数据报服务**



![在这里插入图片描述](网络层.assets/20210323194547616.png)

>  什么是虚电路?和电路交换什么不同：
>
>  回答：虚电路是逻辑上的连接，和电路交换不同；电路交换是真正物理上的电路连接。



## IP数据报的发送和转发过程

IP数据报的发送和转发过程包含了两个部分：

- 主机发送IP数据报
  - 判断目的主机是否和自己在同一个网络中
    - 在一个网络中，则属于直接交付；
    - 若不在同一个网络中，则属于间接交付，传输给主机所在的网络的默认网关（路由器），由默认网关帮忙转发。
- 路由器转发发IP数据报
  1. 检查IP数据报首部是否出错
     1. 若出错，则直接丢失该IP数据报并通报给源主机；
     2. 若没有出错，则进行转发；
  2. 根据IP数据报的目的地址在路由器中查找匹配的条目
     1. 若找到匹配的条目，则转发给条目中的下一跳；
     2. 若找不到，则丢失该IP数据报并通报给源主机；

（忽略ARP协议来获取目的主机或路由器接口的MAC地址的过程以及以太网交换机自学习和转发的过程）



> 问题1：源主机如何知道目的主机是否与自己在同一个网络中？
>
> 用目的IP地址与自己子网掩码相于，得到的目的地址 如果做自己的网络地址不相等，说明不在同一个网络中。



> 问题2: 源主机如何知道路由器的存在呢？
>
> 回答：每个网络都有一个默认网关（默认路由器），当主机和其他网络的主机进行通信时，就见IP数据报传送给默认网关。
>
> 路由器中，一个接口就是一个IP地址。



> 关于下一跳如何写的问题：
>
> - 如果是直接交付，写紧挨目的地址的自己路由器接口编号；
>
> - 如果是间接交付，写==下一个路由器的接口处==的IP地址；



默认路由可以被所有网络匹配，但路由匹配有优先级，默认路由是优先级最低的。

聚合路由中不存在的路由可采用黑洞路由（下一跳为null0【这是路由器内部的虚拟接口，IP数据报进入它后就被丢弃】）的方式去解决。

- 如果不去解决，会出现黑洞路由的情况。
- 最长匹配原则，会优先选择null0；



## 路由选择协议



分类：

- 人工配置路由
- 动态配置路由



因特网路由协议的主要特点：

1. 自适应

   1. 动态路由选择，能较好地适用网络状态的变化

2. 分布式

   1. 路由器之间交换路由信息

3. 分层次

   1. 将整个因特网划分为许多较小的**自治系统AS（在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。）**
      1. 自治系统==之间==的路由选择简称为域间路由选择——————IGP（内部网关协议）
      2. 自治系统==内部==的路由选择简称为域内路由选择——————EGP（外部网关协议）

   EGP和IGP只是路由协议的分类名称，并非实实在在的具体协议。



路由器（网关）协议

- 内部网关协议（IGP）有什么
  - ==路由信息协议RIP==
  - 内部网关协议IGRP
  - 开放式最短路径有线OSPF
  - 中间系统到中间系统IS-IS
  - 内部网关路由协议IGRP
- 外部网关协议EGP
  - 边界网关协议BGP





路由器的基本结构



1. 信号从某个输入端口进入路由器
2. 物理层将信号转换成比特流，送交数据链路层处理
3. 数据链路层识别从比特流中识别出帧，去掉帧头和帧尾后，送交网络层处理
4. 如果送交网络层的分组是普通待转发的数据分组,则
   1. 根据分组首部中的目的地址进行查表转发
   2. 网络层更新数据分组首部中某些字段的值，例如将数据分组的生存时间减1，然后送交数据链路层进行封装
   3. 数据链路层将数据分组封装成帧，交给物理层处理
   4. 物理层将帧看成比特流将其变换成相应的电信号进行发送
5. 若找不到匹配的转发条目，则丢弃该分组，否则，按照匹配条目中所指示的端口进行转发



==路由选择部分==的核心构件是==路由选择处理机==，它的任务是**根据所使用的路由选择协议**。周期性地与其他路由器 进行路由信息的交互，来更新路由表。

路由选择处理机==根据分组的内容==来更新自己的**路由表**

- 路由表和转发表的区别：
  - 只包含从目的地址到下一跳的映射
    - 路由表需要对==网络拓扑变化的计算==最优化
  - 转发表是从路由表的出来
    - 转发表的结构应当使==查询过程==最优化。





## RIP协议

> 要求AS内的每一个路由器都要维护从它到AS内其他每个网络的距离记录，这是一组距离。

- RIP使用跳数作为度量
  - 直连网络距离定义为1
  - 并非直连网络所经过的路由器数+1
  - 允许一条路径最多包含15个路由，“距离” = 16表示不可达。

> - RIP认为好的路由线路就是“距离短”的路由—— 说通过的路由器数最少的路由。
> - 当到达同一网络有多条“距离相等”的路由时，可以进行等价负载均衡



RIP协议的基本工作原理

注意点：

1. 和谁交换信息——（仅和==相邻路由器==交换信息）
2. 交换什么信息——（自己的路由表）
3. 什么时候交换信息——（周期性交换 30s）



RIP的基本工作过程



1. 路由器刚开始工作时，只知道自己直连网络的距离 = 1；
2. 每个路由器仅和相邻路由器周期性地交换并更新路由信息；
3. ==若干次==交换和更新后，每个路由器都知道到达=本AS各网络==的最短距离和下一跳的地址，称作收敛。



对方路由器的路由信息传过来以后，

1. 改造：距离+1，下一跳改为对方路由器
2. 更新：
   1. 发现新的网络，添加
   2. 发现旧的路由路径更短，更细
   3. 到达目的网络，不同于之前的下一跳，但是路径等价，添加（可做负载均衡）

**RIP存在“坏消息传播得慢”的问题解决**

> 坏消息传的慢。又称作路由环路或者距离无穷记数问题，这是距离向量算法的一个固有问题。可以采用多种措施==减少==该问题的概率或者减少该问题带来的危害,例如：

- 限制最大路径为15
- 当路由表发送变化就立即发送更新报文（“触发更细”），不仅仅是周期性发送
- ）*反向下毒*：让路由器记录收到的特定路由信息的接口（毒），而不是让同一个路由信息再次通过该接口方向传送（“水平分隔”）

但是，这些方法也不能完全解决“坏消息传播得慢”的问题，这是距离向量的本质决定



RIP 协议的优缺点

优点：

1. 实现简单，开销较小。

缺点：

1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
2. 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
3. “坏消息传播得慢”，使更新过程的收敛时间过长。



## RIP 协议的优缺点

优点：

1. 实现简单，开销较小。

缺点：

1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
2. 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
3. “坏消息传播得慢”，使更新过程的收敛时间过长。





## 开放最短路径优先OSPF



**注意**：OSPF（Open Shortest Path First） 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。



OSPF（Open Shortest Path First）的背景：是为了克服RIP的缺点在1989年年开发出来的。

- Open：公开发表，不属于任一一家公司；
- Shortest Path First：使用 迪杰斯特拉提出的最短路径算法 SPF



OSPF是基于==链路状态==的，在算法上保证了不会形成环路。

OSPF不显示网络规模，更新效率高。收敛速度快。

> 链路状态：指的是本路由器和==那些路由器相邻==，以及相应的链路“代价（cost）”
>
> - 代价：用来表示费用，距离，时延，带宽。。。。；具体表示什么犹豫网络管理员指定。



![image-20210909114034678](网络层.assets/image-20210909114034678.png)

思科代价越大越不好。

OSPF的基本过程：

1. 相邻路由器之间通过问候（hello）分组，建立邻居关系

   1. hello分组封装在IP数据报中，以组播的形式发给相邻路由器。（IP数据报首部中协议号字段的取值应为89，来表明IP数据报的数据载荷为OSPF分组）

   ![image-20210909114552192](网络层.assets/image-20210909114552192.png)

   2. 每隔10S发送一次，用来告诉邻居路由器，还自己还活着

   3. 如果40S内收到邻居路由器的Hello分组，就任务该邻居路由器不可达。

   ![image-20210909114417023](网络层.assets/image-20210909114417023.png)

   从自己的1号口出去，就能到R2路由器，倒计时40S开始。

   

链路状态更新分组由两种使用方式

- 有了邻居做了请求，发送链路状态更新分组
- 自己做出改变，发出链路状态更新分组


最大传输单元 MTU： 数据链路层携带的数据量的大小。数据链路层最大携带1500字节。



片偏移：0表示不偏移。用首个数据的字节编号/8 就是片偏移。



## ICMP

分类：

- 差错报文ICMP
- 询问报文ICMP





## VPN（IP隧道技术）

将（要内部发的IP数据报）封装到（外界的IP数据报)中



## NAPT

- 因特网的路由器上安装NAT软件
- 这种利用端口号和IP地址一起进行转换的技术叫做网络地址与端口转换NAPT（Network Address and Port Translation）



## 网络层和数据链路层的对比

https://blog.csdn.net/weixin_43762820/article/details/108931357?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.no_search_link
